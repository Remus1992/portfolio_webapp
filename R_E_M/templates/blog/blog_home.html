{% extends 'base.html' %}

{% load static %}
{% load R_E_M_tags %}

{% block title %}
    : Blog Home
{% endblock %}
{% block css %}
    <style>
        body {
            font-family: 'Alegreya Sans SC', sans-serif;
        }
    </style>
{% endblock %}
{% block content %}
    <head>
        <link rel="stylesheet" type="text/css" href="{% static 'styles/style.css' %}"/>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    </head>
    <div class="page_container">
        <div class="search_container">
            <form method="GET" action="">
                <div class="search_div">
                    <input type="text" name="q" placeholder="Search..." id="search_bar" value="{{ request.GET.q }}">
                    <button type="submit" value="Search" class="search_button"><img src="/static/R_E_M/img/search_icon.png" alt="search_logo"
                                                          id="search_img"/></button>
                </div>
            </form>
        </div>
        <div class="categories-link-set">
            {% for c in cat %}
                <!--
                    <input class="filter-checkbox" type="checkbox" value="3" id="Filter_industry_3" name="Filter[industry][]">
                    <label for="Filter_industry_3"><span>Architecture</span></label>
                -->
                <span class="checkbox" id="{{ c.slug }}">
                <input class="filter-checkbox" type="checkbox">
                <label for="{{ c.name }}">{{ c.name }}</label>
            </span>
            {% endfor %}

        </div>
        <div class="line_container">
            <hr>
        </div>
        <div class="ajax_div">
        </div>
        <div class="container">
            {% if user.is_authenticated %}
                <h4 id="blogModalBtn">Create New Blog</h4>
                <br>
                <!-- The Modal -->
                <div id="blogModal" class="blog_modal">

                    <!-- Modal content -->
                    <div class="blog_modal_content">

                        <form method="post" enctype="multipart/form-data" class="blog_upload_form">
                            {% csrf_token %}
                            <div class="blog-input-row">
                                <h2>Blog Upload</h2>
                                <span>
                                <span class="blog-close">&times;</span>
                            </span>
                            </div>
                            <div class="blog_gallery">
                                <div class="blog_info">
                                    <input type="text" id="blog_title" name="blog_title" class="resizedTextbox" placeholder="Blog Title">
                                    <input list="categories" id="category" name="category" placeholder="Blog Category" class="resizedTextbox">
                                    <datalist id="categories">{% for c in cat %}<option value="{{ c.name }}">{% endfor %}</datalist>
                                    <input type="text" id="youtube_link" name="youtube_link" placeholder="YouTube Link" class="resizedTextbox">
                                    <br>
                                    <br>
                                    <br>
                                    <p>Blog Image</p>
                                    <input type="file" id="blog_image" name="blog_image" class="resizedTextbox">
                                    <input type="text" id="alt_text" name="alt_text" placeholder="Alt Text" class="resizedTextbox">
                                </div>
                                <div class="blog-details-row">
                                    <textarea id="blog_content" name="blog_content" cols="30" rows="10" placeholder="Blog Content"></textarea>
                                </div>
                            </div>
                            <div class="blog-submit-row">
                                <input class='blog_modal_btn' type="submit" id="sub-btn" value="Create Blog">
                            </div>
                        </form>
                    </div>
                </div>

            {% endif %}
        </div>
        <div class="blog_container" id="blog_container">
            {% for b in blogs %}
                <div class="blog {{ b.category.slug }}" data-image-src>
                    <div class="image_holder" data-parallax="scroll" data-src="{{ b.image.url }}"
                         data-image-src="{{ b.image.url }}">
                        <a href="{% url 'blog_single_view' b.category.slug b.slug %}"
                           class="blog_button">Read More &nbsp; &nbsp; &nbsp; &nbsp;></a>
                    </div>

                    <div class="main_content">
                        <div class="category">Blog / {{ b.category }}</div>
                        <h2 class="blog-title"> {{ b.title }}</h2>
                        <div class="card-footer"><i>~ Posted on {{ b.date }}</i></div>
                        <pre class="blog-text">{{ b.content }}</pre>
                        <div class="blog_fade"></div>
                    </div>
                </div>
            {% endfor %}
        </div>

    </div>
    <script src="{% static 'javascript/parallax.js-1.5.0/parallax.js' %}"></script>

    <script>

        $('.checkbox').click(function () {
            let cat = this.id;

            // removing shade from other elements
            $('.checkbox').each(function (i, el) {
                $(el).removeClass('checkFocus');
            });

            /*
                        // remove parallax
                        $('.image_holder').parallax('destroy');
                        $('.blog').each(function (i, el) {

                            let img = $(el).find('.image_holder');
                            if (!$(el).hasClass(cat)) {
                                $(el).hide();
                            } else {
                                $(el).show();
                            }
                        });
                        $('.image_holder').parallax('render');
            */
            $(this).addClass('checkFocus');
        });


        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                let cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    let cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        let csrftoken = getCookie('csrftoken');

        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

        $.ajaxSetup({
            beforeSend: function (xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });

        $(".checkbox").click(function () {
            let cat = this.id;
            console.log(cat);
            $.ajax({
                url: "{% url "blog_ajax" %}",
                method: "POST",
                data: {
                    category: cat
                },
                success: function (response) {
                    console.dir(response);
                    $('.image_holder').parallax('destroy');
                    let bc = $("#blog_container");
                    let html = "";
                    $(bc).html('');
                    $(response).each(function (i, b) {
                        console.dir(b)
                        html += `<div class="blog ${b.category.slug}" data-image-src>
                    <div class="image_holder" data-parallax="scroll" data-src="${b.image.url}"
                         data-image-src="${b.image.url}">
                         <a href="/blog/${b.category.slug}/${b.slug}/"
                           class="blog_button">Read More &nbsp; &nbsp; &nbsp; &nbsp;></a>
                    </div>

                    <div class="main_content">
                        <div class="category">Blog / ${b.category.name}</div>
                        <h2 class="blog-title">${b.title}</h2>
                        <div class="card-footer"><i>~ Posted on ${b.date}</i></div>
                        <pre class="blog-text">${b.content}</pre></div></div>`
                    });
                    $(bc).html(html);
                    $('.image_holder').parallax('render');
                }
            });
        })

        // Get the modal
        let blogUploadModal = document.getElementById('blogModal');

        // Get the button that opens the modal
        let blogBtn = document.getElementById("blogModalBtn");

        // Get the <span> element that closes the modal
        let span = document.getElementsByClassName("blog-close")[0];

        // When the user clicks the button, open the modal
        blogBtn.onclick = function() {
            blogUploadModal.style.display = "block";
        };

        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
            blogUploadModal.style.display = "none";
            let blog_html = '<div class="blog_info"><input type="text" id="blog_title" name="blog_title" class="resizedTextbox" placeholder="Blog Title"><input list="categories" id="category" name="category" placeholder="Blog Category" class="resizedTextbox"><datalist id="categories">{% for c in cat %}<option value="{{ c.name }}">{% endfor %}</datalist><input type="text" id="youtube_link" name="youtube_link" placeholder="YouTube Link" class="resizedTextbox"><br><br><br><p>Blog Image</p><input type="file" id="blog_image" name="blog_image" class="resizedTextbox"><input type="text" id="alt_text" name="alt_text" placeholder="Alt Text" class="resizedTextbox"></div><div class="blog-details-row"><textarea id="blog_content" name="blog_content" cols="30" rows="10" placeholder="Blog Content"></textarea></div>'
            $("div.blog_gallery").html(blog_html);
        };
    </script>
{% endblock %}

{% block footer %}
    {% include 'footer_base.html' %}
{% endblock %}